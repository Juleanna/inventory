#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ç–∞ –∑–∞–ø—É—Å–∫—É –ø—Ä–æ–µ–∫—Ç—É –≤ Docker
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: ./docker-init.sh

echo "üöÄ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Inventory Management System –≤ Docker..."

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ Docker –∑–∞–ø—É—â–µ–Ω–∏–π
if ! docker info > /dev/null 2>&1; then
    echo "‚ùå Error: Docker –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π. –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø—É—Å—Ç—ñ—Ç—å Docker —ñ —Å–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É."
    exit 1
fi

# –ó—É–ø–∏–Ω—è—î–º–æ –≤—Å—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏, —è–∫—â–æ –≤–æ–Ω–∏ –ø—Ä–∞—Ü—é—é—Ç—å
echo "üõë –ó—É–ø–∏–Ω—è—î–º–æ —ñ—Å–Ω—É—é—á—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏..."
docker-compose down

# –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –æ–±—Ä–∞–∑–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
read -p "–ß–∏ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä—ñ –æ–±—Ä–∞–∑–∏? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üóëÔ∏è  –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –æ–±—Ä–∞–∑–∏..."
    docker-compose down --rmi all --volumes --remove-orphans
fi

# –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
echo "üìÅ –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó..."
mkdir -p logs
mkdir -p media
mkdir -p staticfiles

# –ö–æ–ø—ñ—é—î–º–æ —Ñ–∞–π–ª —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
if [ ! -f .env ]; then
    echo "üìã –ö–æ–ø—ñ—é—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞..."
    cp .env.docker .env
    echo "‚ö†Ô∏è  –í–ê–ñ–õ–ò–í–û: –í—ñ–¥—Ä–µ–¥–∞–≥—É–π—Ç–µ —Ñ–∞–π–ª .env —Ç–∞ –∑–º—ñ–Ω—ñ—Ç—å –ø–∞—Ä–æ–ª—ñ —Ç–∞ —Å–µ–∫—Ä–µ—Ç–Ω—ñ –∫–ª—é—á—ñ!"
fi

# –ë—É–¥—É—î–º–æ –æ–±—Ä–∞–∑–∏
echo "üî® –ë—É–¥—É—î–º–æ Docker –æ–±—Ä–∞–∑–∏..."
docker-compose build --no-cache

# –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –±–∞–∑—É –¥–∞–Ω–∏—Ö —Ç–∞ Redis –¥–ª—è –º—ñ–≥—Ä–∞—Ü—ñ–π
echo "üóÑÔ∏è  –ó–∞–ø—É—Å–∫–∞—î–º–æ –±–∞–∑—É –¥–∞–Ω–∏—Ö —Ç–∞ Redis..."
docker-compose up -d db redis

# –ß–µ–∫–∞—î–º–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
echo "‚è≥ –û—á—ñ–∫—É—î–º–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..."
sleep 10

# –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –º—ñ–≥—Ä–∞—Ü—ñ—ó
echo "üîÑ –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –º—ñ–≥—Ä–∞—Ü—ñ—ó..."
docker-compose run --rm web python manage.py migrate

# –°—Ç–≤–æ—Ä—é—î–º–æ —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
echo "üë§ –°—Ç–≤–æ—Ä—é—î–º–æ —Å—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞..."
docker-compose run --rm web python manage.py shell -c "
from django.contrib.auth import get_user_model
User = get_user_model()
if not User.objects.filter(username='admin').exists():
    User.objects.create_superuser('admin', 'admin@inventory.local', 'securepassword123')
    print('–°—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Å—Ç–≤–æ—Ä–µ–Ω–æ: admin / securepassword123')
else:
    print('–°—É–ø–µ—Ä–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ —ñ—Å–Ω—É—î')
"

# –ó–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ç–∏—á–Ω—ñ —Ñ–∞–π–ª–∏
echo "üì¶ –ó–±–∏—Ä–∞—î–º–æ —Å—Ç–∞—Ç–∏—á–Ω—ñ —Ñ–∞–π–ª–∏..."
docker-compose run --rm web python manage.py collectstatic --noinput

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –≤—Å—ñ —Å–µ—Ä–≤—ñ—Å–∏
echo "üöÄ –ó–∞–ø—É—Å–∫–∞—î–º–æ –≤—Å—ñ —Å–µ—Ä–≤—ñ—Å–∏..."
docker-compose up -d

echo "‚úÖ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üåê –î–æ–¥–∞—Ç–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ –∞–¥—Ä–µ—Å–æ—é: http://localhost:8000"
echo "üîê –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è: http://localhost:8000/admin"
echo "üë§ –õ–æ–≥—ñ–Ω: admin"
echo "üîë –ü–∞—Ä–æ–ª—å: securepassword123"
echo ""
echo "üìä –î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –ª–æ–≥—ñ–≤: docker-compose logs -f"
echo "üõë –î–ª—è –∑—É–ø–∏–Ω–∫–∏: docker-compose down"
echo ""
echo "‚ö†Ô∏è  –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—ñ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ!"

# –ü–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤
echo "üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤:"
docker-compose ps