{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Inventory">
    <meta name="theme-color" content="#28a745">
    <meta name="msapplication-TileColor" content="#28a745">
    <meta name="application-name" content="IT Equipment Inventory">
    
    <title>{% block title %}–Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è IT{% endblock %}</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- Favicon —Ç–∞ —ñ–∫–æ–Ω–∫–∏ -->
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'icons/icon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'icons/icon-16x16.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'icons/apple-touch-icon.png' %}">
    <link rel="mask-icon" href="{% static 'icons/safari-pinned-tab.svg' %}" color="#28a745">
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'css/pwa.css' %}" rel="stylesheet">
    <link href="{% static 'css/mobile.css' %}" rel="stylesheet">
    
    {% block extra_css %}{% endblock %}
    
    <!-- –ü—Ä–µ–ª–æ–∞–¥–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤ -->
    <link rel="preload" href="{% static 'js/app.js' %}" as="script">
    <link rel="preload" href="{% static 'js/pwa.js' %}" as="script">
</head>
<body class="mobile-layout {% block body_class %}{% endblock %}">
    <!-- –ü—Ä–µ–ª–æ–∞–¥–µ—Ä -->
    <div id="app-loader" class="app-loader">
        <div class="loader-content">
            <div class="loader-logo">üì±</div>
            <div class="loader-spinner"></div>
            <div class="loader-text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
    </div>

    <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è -->
    <nav class="mobile-navbar" id="mobileNavbar">
        <div class="navbar-brand">
            <i class="fas fa-boxes"></i>
            <span>Inventory</span>
        </div>
        
        <div class="navbar-actions">
            {% if user.is_authenticated %}
                <button class="btn-icon" id="notificationBtn" title="–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                
                <button class="btn-icon" id="searchBtn" title="–ü–æ—à—É–∫">
                    <i class="fas fa-search"></i>
                </button>
                
                <button class="btn-icon" id="menuBtn" title="–ú–µ–Ω—é">
                    <i class="fas fa-bars"></i>
                </button>
            {% endif %}
        </div>
    </nav>

    <!-- –ü–æ—à—É–∫–æ–≤–∞ –ø–∞–Ω–µ–ª—å -->
    <div class="search-panel" id="searchPanel">
        <div class="search-input-group">
            <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ—à—É–∫ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è..." autocomplete="off">
            <button class="search-clear-btn" id="searchClearBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="search-filters">
            <button class="filter-chip active" data-filter="all">–í—Å–µ</button>
            <button class="filter-chip" data-filter="equipment">–û–±–ª–∞–¥–Ω–∞–Ω–Ω—è</button>
            <button class="filter-chip" data-filter="users">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</button>
            <button class="filter-chip" data-filter="locations">–õ–æ–∫–∞—Ü—ñ—ó</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- –ë—ñ—á–Ω–µ –º–µ–Ω—é -->
    <div class="mobile-sidebar" id="mobileSidebar">
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <div class="sidebar-content">
            <div class="sidebar-header">
                <div class="user-info">
                    {% if user.is_authenticated %}
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                            <div class="user-role">{{ user.profile.get_position_display|default:"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á" }}</div>
                        </div>
                    {% endif %}
                </div>
                <button class="sidebar-close-btn" id="sidebarCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="sidebar-menu">
                <a href="/dashboard/" class="menu-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>–î–∞—à–±–æ—Ä–¥</span>
                </a>
                
                <a href="/equipment/" class="menu-item {% if request.resolver_match.url_name == 'equipment' %}active{% endif %}">
                    <i class="fas fa-laptop"></i>
                    <span>–û–±–ª–∞–¥–Ω–∞–Ω–Ω—è</span>
                </a>
                
                <a href="/notifications/" class="menu-item {% if request.resolver_match.url_name == 'notifications' %}active{% endif %}">
                    <i class="fas fa-bell"></i>
                    <span>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</span>
                </a>
                
                <a href="/scan/" class="menu-item {% if request.resolver_match.url_name == 'scan' %}active{% endif %}">
                    <i class="fas fa-qrcode"></i>
                    <span>QR –°–∫–∞–Ω–µ—Ä</span>
                </a>
                
                <a href="/reports/" class="menu-item {% if request.resolver_match.url_name == 'reports' %}active{% endif %}">
                    <i class="fas fa-chart-bar"></i>
                    <span>–ó–≤—ñ—Ç–∏</span>
                </a>
                
                {% if user.is_staff %}
                <div class="menu-divider"></div>
                <div class="menu-group-title">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è</div>
                
                <a href="/admin/" class="menu-item" target="_blank">
                    <i class="fas fa-cog"></i>
                    <span>–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</span>
                </a>
                
                <a href="/maintenance/" class="menu-item">
                    <i class="fas fa-tools"></i>
                    <span>–¢–µ—Ö–Ω—ñ—á–Ω–µ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è</span>
                </a>
                
                <a href="/spare-parts/" class="menu-item">
                    <i class="fas fa-puzzle-piece"></i>
                    <span>–ó–∞–ø—á–∞—Å—Ç–∏–Ω–∏</span>
                </a>
                {% endif %}
                
                <div class="menu-divider"></div>
                
                <a href="/profile/" class="menu-item">
                    <i class="fas fa-user-cog"></i>
                    <span>–ü—Ä–æ—Ñ—ñ–ª—å</span>
                </a>
                
                <a href="/settings/" class="menu-item">
                    <i class="fas fa-sliders-h"></i>
                    <span>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span>
                </a>
                
                <button class="menu-item" id="installAppBtn" style="display: none;">
                    <i class="fas fa-download"></i>
                    <span>–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫</span>
                </button>
                
                <a href="{% url 'admin:logout' %}" class="menu-item">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>–í–∏–π—Ç–∏</span>
                </a>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="main-content" id="mainContent">
        {% if messages %}
            <div class="messages-container">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- –ü–ª–∞–≤–∞—é—á–∞ –∫–Ω–æ–ø–∫–∞ –¥—ñ–π -->
    <div class="fab-container" id="fabContainer">
        <button class="fab fab-main" id="fabMain">
            <i class="fas fa-plus"></i>
        </button>
        
        <div class="fab-menu" id="fabMenu">
            <button class="fab fab-secondary" id="addEquipmentBtn" title="–î–æ–¥–∞—Ç–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è">
                <i class="fas fa-laptop"></i>
            </button>
            
            <button class="fab fab-secondary" id="scanQRBtn" title="–°–∫–∞–Ω—É–≤–∞—Ç–∏ QR">
                <i class="fas fa-qrcode"></i>
            </button>
            
            <button class="fab fab-secondary" id="quickReportBtn" title="–®–≤–∏–¥–∫–∏–π –∑–≤—ñ—Ç">
                <i class="fas fa-bug"></i>
            </button>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è -->
    <nav class="bottom-nav" id="bottomNav">
        <a href="/dashboard/" class="nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
            <i class="fas fa-home"></i>
            <span>–ì–æ–ª–æ–≤–Ω–∞</span>
        </a>
        
        <a href="/equipment/" class="nav-item {% if request.resolver_match.url_name == 'equipment' %}active{% endif %}">
            <i class="fas fa-laptop"></i>
            <span>–û–±–ª–∞–¥–Ω–∞–Ω–Ω—è</span>
        </a>
        
        <a href="/scan/" class="nav-item {% if request.resolver_match.url_name == 'scan' %}active{% endif %}">
            <i class="fas fa-qrcode"></i>
            <span>–°–∫–∞–Ω–µ—Ä</span>
        </a>
        
        <a href="/notifications/" class="nav-item {% if request.resolver_match.url_name == 'notifications' %}active{% endif %}">
            <i class="fas fa-bell"></i>
            <span>–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</span>
            <span class="nav-badge" id="navNotificationBadge">0</span>
        </a>
        
        <a href="/profile/" class="nav-item {% if request.resolver_match.url_name == 'profile' %}active{% endif %}">
            <i class="fas fa-user"></i>
            <span>–ü—Ä–æ—Ñ—ñ–ª—å</span>
        </a>
    </nav>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ -->
    {% block modals %}{% endblock %}

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/pwa.js' %}"></script>
    <script src="{% static 'js/mobile.js' %}"></script>
    <script src="{% static 'js/app.js' %}"></script>
    
    {% block extra_js %}{% endblock %}

    <script>
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø—Ä–µ–ª–æ–∞–¥–µ—Ä
            setTimeout(() => {
                const loader = document.getElementById('app-loader');
                if (loader) {
                    loader.classList.add('fade-out');
                    setTimeout(() => loader.remove(), 300);
                }
            }, 1000);

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –º–æ–±—ñ–ª—å–Ω—É –Ω–∞–≤—ñ–≥–∞—Ü—ñ—é
            if (window.MobileApp) {
                window.mobileApp = new MobileApp();
            }

            // –û–Ω–æ–≤–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω—å
            updateNotificationBadges();
        });

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤ —Å–ø–æ–≤—ñ—â–µ–Ω—å
        function updateNotificationBadges() {
            fetch('/api/notifications/unread-count/')
                .then(response => response.json())
                .then(data => {
                    const count = data.count || 0;
                    const badges = document.querySelectorAll('#notificationBadge, #navNotificationBadge');
                    
                    badges.forEach(badge => {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.style.display = count > 0 ? 'block' : 'none';
                    });
                })
                .catch(console.error);
        }

        // –ü–µ—Ä—ñ–æ–¥–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å
        setInterval(updateNotificationBadges, 30000);
    </script>
</body>
</html>